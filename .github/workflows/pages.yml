name: pages
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install root deps
        run: npm ci

      - name: Install app deps
        working-directory: app
        run: npm ci

      - name: Build Expo web (static export)
        working-directory: app
        run: |
          rm -rf dist
          npx expo export --platform web --output-dir dist

      - name: Patch HTML for /sprout subpath and correct index-*.js path
        working-directory: app
        run: |
          node - <<'NODE'
          const fs = require('fs');
          const path = require('path');

          const DIST = 'dist';
          const HTMLS = ['index.html', '404.html'].map(f => path.join(DIST, f)).filter(fp => fs.existsSync(fp));
          const WEB_DIR = path.join(DIST, '_expo', 'static', 'js', 'web');

          // Find the real hashed index-*.js that Expo built
          let hashedIndex = null;
          if (fs.existsSync(WEB_DIR)) {
            const files = fs.readdirSync(WEB_DIR)
              .filter(f => /^index-.*\.js$/.test(f))
              .sort(); // in case there are multiple, last wins
            if (files.length) hashedIndex = files[files.length - 1];
          }

          for (const fp of HTMLS) {
            let html = fs.readFileSync(fp, 'utf8');

            // Ensure base href=/sprout/ (helps relative assets)
            if (!/\<base\s+href=/.test(html)) {
              html = html.replace('<head>', '<head>\n  <base href="/sprout/">');
            }

            // Fix any absolute paths that miss the /sprout prefix
            html = html.replace(/"\/*_expo\//g, '"/sprout/_expo/');
            html = html.replace(/href="\/favicon\.ico"/g, 'href="/sprout/favicon.ico"');
            html = html.replace(/href="\/assets\//g, 'href="/sprout/assets/');

            // If the HTML references index-*.js directly (root), rewrite to /sprout/_expo/static/js/web/<hash>
            if (hashedIndex) {
              // src="/index-<hash>.js"  OR  src="index-<hash>.js"  OR any variant
              html = html.replace(/src="\/?index-[^"]+\.js"/g, `src="/sprout/_expo/static/js/web/${hashedIndex}"`);
              // preload link: <link rel="modulepreload" href="/index-<hash>.js">
              html = html.replace(/href="\/?index-[^"]+\.js"/g, `href="/sprout/_expo/static/js/web/${hashedIndex}"`);
            }

            fs.writeFileSync(fp, html, 'utf8');
            console.log('Patched', fp);
          }

          // Ensure favicon exists where the HTML points
          const favSrcPng = path.join(DIST, 'assets', 'icon.png'); // from Expo config
          const favDstIco = path.join(DIST, 'favicon.ico');
          if (!fs.existsSync(favDstIco)) {
            // If you have a real .ico, copy it instead; otherwise duplicate the png to prevent 404
            try {
              if (fs.existsSync(favSrcPng)) fs.copyFileSync(favSrcPng, favDstIco);
            } catch (e) { /* ignore */ }
          }
          NODE

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: app/dist

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
