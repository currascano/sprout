name: pages
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install root dependencies
        run: npm ci

      - name: Install app dependencies
        working-directory: app
        run: npm ci

      - name: Build Expo Web
        working-directory: app
        run: |
          rm -rf dist
          npx expo export --platform web --output-dir dist --public-url ./

      - name: Fix bundle paths + cache-bust + remove SW
        working-directory: app
        env:
          GITHUB_SHA: ${{ github.sha }}
        run: |
          node << 'NODE'
          const fs = require('fs');
          const path = require('path');

          const dist = 'dist';

          // Remove service worker files if they exist
          ['sw.js','register-service-worker.js','service-worker.js'].forEach(f => {
            const p = path.join(dist, f);
            if (fs.existsSync(p)) fs.rmSync(p, { force: true });
          });

          // Find hashed index file
          const webDir = path.join(dist, '_expo/static/js/web');
          let hashed = null;
          if (fs.existsSync(webDir)) {
            const files = fs.readdirSync(webDir)
              .filter(f => /^index-.*\.js$/.test(f))
              .sort();
            hashed = files.pop();
          }

          const htmlFiles = ['index.html', '404.html'];

          for (const file of htmlFiles) {
            const fp = path.join(dist, file);
            if (!fs.existsSync(fp)) continue;

            let html = fs.readFileSync(fp, 'utf8');

            // Base tag for GH Pages subpath
            if (!html.includes('<base href="/sprout/">')) {
              html = html.replace('<head>', `<head><base href="/sprout/">`);
            }

            // Cache bust meta
            html = html.replace('<head>', `<head>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />`);

            // Rewrite _expo paths
            html = html.replace(/"\/_expo\//g, '"/sprout/_expo/');

            // Point to the hashed bundle and add cache-busting
            if (hashed) {
              const newPath = `/sprout/_expo/static/js/web/${hashed}?v=${process.env.GITHUB_SHA}`;
              html = html.replace(/src="[^"]*index-.*\.js[^"]*"/, `src="${newPath}"`);
            }

            fs.writeFileSync(fp, html, 'utf8');
            console.log(`Patched: ${file}`);
          }
          NODE

      - name: Upload static artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: app/dist

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
